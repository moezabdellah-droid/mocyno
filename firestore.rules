rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Auth Helpers
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Récupérer le rôle depuis le document agent de l'utilisateur
    function getUserData() {
      let path = /databases/$(database)/documents/agents/$(request.auth.uid);
      return exists(path) ? get(path).data : {};
    }
    
    function hasRole(role) {
      let data = getUserData();
      return isAuthenticated() && (data != null && data.role == role);
    }
    
    // Rôles
    function isAdmin() { return hasRole('admin'); }
    function isManager() { return hasRole('manager'); }
    function isAdminOrManager() { 
      // Optimisation: lire une seule fois si possible, mais ici logique 'OR'
      return isAdmin() || isManager(); 
    }

    // --- COLLECTIONS ---

    // 1. CONSIGNES (CORRECTIF)
    match /consignes/{consigneId} {
      allow read: if isAuthenticated();
      // UPDATE: Seuls Admin et Manager peuvent écrire
      allow write: if isAdminOrManager();
    }

    // 2. AGENTS
    match /agents/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAdminOrManager();
      allow update: if isAdminOrManager() || (isAuthenticated() && request.auth.uid == userId);
      allow delete: if isAdmin();
    }
    
    // 3. PLANNING
    match /planning/{shiftId} {
      allow read: if isAuthenticated(); // Tout agent peut voir le planning
      allow write: if isAdminOrManager();
    }

    // 4. EVENTS (Main Courante)
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated(); // Tout agent peut créer un rapport
      allow update: if isAdminOrManager(); // Modification restreinte
      allow delete: if isAdminOrManager();
    }

    // 5. SITES
    match /sites/{siteId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrManager();
    }

    // Default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
