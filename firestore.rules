rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/agents/$(request.auth.uid)).data;
    }
    
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isManager() {
      return hasRole('manager');
    }
    
    function isAdminOrManager() {
      return isAuthenticated() && (getUserData().role == 'admin' || getUserData().role == 'manager');
    }

    // Agents Collection
    // Admins can manage everything.
    // Managers can read all agents but not modify admins (logic simplified here for Firestore, UI handles specifics)
    // Agents can only read their own profile.
    match /agents/{userId} {
      allow read: if isAuthenticated(); // Broad read for now to allow viewing colleagues, or restrict to Admin/Manager + Self
      allow create: if isAdminOrManager();
      allow update: if isAdminOrManager() || (isAuthenticated() && request.auth.uid == userId); // Agents can update self (e.g. photo)
      allow delete: if isAdmin();
    }

    // Consignes
    // Read: All authenticated
    // Write: All authenticated (Temporary for debugging)
    match /consignes/{consigneId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Planning
    // Read: All authenticated
    // Write: Admin/Manager only
    match /planning/{shiftId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrManager();
    }

    // Sites
    // Read: All authenticated
    // Write: Admin/Manager only
    match /sites/{siteId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrManager();
    }

    // Main Courante / Reports (Events)
    // Read: All authenticated
    // Create: All authenticated (Agents create reports)
    // Update/Delete: Admin/Manager only (prevent tampering)
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAdminOrManager();
      allow delete: if isAdminOrManager();
    }

    // Default deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
